files:
  "/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.d/file-beanstalk.json":
    mode: "000644"
    owner: root
    group: root
    content: |
      {
      	"logs": {
      		"logs_collected": {
      			"files": {
      				"collect_list": [
      					{
      						"file_path": "/var/log/eb-engine.log",
      						"log_group_name": "/aws/elasticbeanstalk/sulsul-server-eb-env/var/log/eb-engine.log",
      						"log_stream_name": "{instance_id}"
      					},
      					{
      						"file_path": "/var/log/eb-hooks.log",
      						"log_group_name": "/aws/elasticbeanstalk/sulsul-server-eb-env/var/log/eb-hooks.log",
      						"log_stream_name": "{instance_id}"
      					},
      					{
      						"file_path": "/var/log/nginx/access.log",
      						"log_group_name": "/aws/elasticbeanstalk/sulsul-server-eb-env/var/log/nginx/access.log",
      						"log_stream_name": "{instance_id}"
      					},
      					{
      						"file_path": "/var/log/nginx/error.log",
      						"log_group_name": "/aws/elasticbeanstalk/sulsul-server-eb-env/var/log/nginx/error.log",
      						"log_stream_name": "{instance_id}"
      					},
      					{
      						"file_path": "/var/log/web.stdout.log",
      						"log_group_name": "/aws/elasticbeanstalk/sulsul-server-eb-env/var/log/web.stdout.log",
      						"log_stream_name": "{instance_id}"
      					},
      					{
      					    "file_path": "/var/app/current/logs/sulsul/info.log",
                            "log_group_name": "/aws/elasticbeanstalk/sulsul-backend/application-info.log",
                            "log_stream_name": "{current_time}"
      					},
      					{
                            "file_path": "/var/app/current/logs/sulsul/debug.log",
                            "log_group_name": "/aws/elasticbeanstalk/sulsul-backend/application-debug.log",
                            "log_stream_name": "{current_time}"
                        },
                        {
                            "file_path": "/var/app/current/logs/sulsul/error.log",
                            "log_group_name": "/aws/elasticbeanstalk/sulsul-backend/application-error.log",
                            "log_stream_name": "{current_time}"
                        },
      				]
      			}
      		}
      	}
      }

commands:
  01_set_log_stream_name:
    command: |
      current_time=$(date +%Y%m%d%H%M%S)
      sed -i "s/{current_time}/$current_time/g;" /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.d/file-beanstalk.json
  02_restart_agent:
    command: "service amazon-cloudwatch-agent restart"

